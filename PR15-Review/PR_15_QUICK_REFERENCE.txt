â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                          PR #15 REVIEW SUMMARY                             â•‘
â•‘                  SQLite + Hybrid Search Refactor                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STATUS: ğŸŸ¡ REQUEST CHANGES (Good direction, critical bugs block merge)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Š CHANGE OVERVIEW
  â€¢ 1,653 lines added, 586 deleted
  â€¢ 11 files changed
  â€¢ JSONL + in-memory FAISS â†’ SQLite + thread-safe wrapper
  â€¢ Hybrid search (FTS + vector)
  â€¢ Agent memory structures (goal, plan, outcome, tool_logs)
  â€¢ CLI + TUI for testing

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… WHAT'S GOOD (7 points)
  1. SQLite + WAL mode fixes JSONL concurrency issues
  2. Thread-safe FAISS wrapper (lock-based)
  3. FTS5 for hybrid search (keyword + semantic)
  4. Multi-tenant support preserved
  5. New agent-ready memory structures
  6. Proper schema per layer
  7. CLI + TUI for interactive testing

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âŒ CRITICAL ISSUES (6 must-fix)

1. ğŸ”´ FAISS â†” DB SYNC RACE CONDITION (4h to fix)
   â€¢ DB write succeeds, FAISS write fails
   â€¢ Result: Memory in DB but not searchable (data loss)
   â€¢ Fix: Implement recovery on startup

2. ğŸ”´ MISSING AUTO-SAVE (2h to fix)
   â€¢ vector_store.save() not called automatically
   â€¢ Comments suggest uncertainty: "Or maybe just periodically?"
   â€¢ Result: FAISS only in memory, crash = vector loss
   â€¢ Fix: Debounce auto-save every 5 seconds

3. ğŸŸ¡ HYBRID SEARCH UNWEIGHTED (1h to fix)
   â€¢ Parameter semantic_weight=0.7 ACCEPTED but NOT USED
   â€¢ Both FTS and vectors get equal weight (broken feature)
   â€¢ Fix: Implement weighted RRF fusion

4. ğŸŸ¡ NO EXPIRATION CLEANUP (2h to fix)
   â€¢ Session/working memories with TTL never deleted
   â€¢ DB grows unbounded with dead records
   â€¢ Fix: Background task every 1 hour

5. ğŸŸ¡ FTS TRIGGERS FRAGILE (3h to fix)
   â€¢ Triggers can become inconsistent if mid-transaction fails
   â€¢ Manual SQL bypasses triggers
   â€¢ Fix: Sync FTS in app after commit (not triggers)

6. ğŸŸ¡ TEST COVERAGE ~40% (6h to fix)
   â€¢ Missing: concurrent writes, recovery, hybrid search weights
   â€¢ Only 106 total test lines for 1600+ lines of new code
   â€¢ Fix: Add comprehensive test suite

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“‹ TOTAL EFFORT TO FIX: ~18 hours

  Issue                    Hours    Priority
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  FAISS â†” DB sync            4    ğŸ”´ CRITICAL
  Auto-save                  2    ğŸ”´ CRITICAL  
  Hybrid search weight       1    ğŸŸ¡ MEDIUM
  Expiration cleanup         2    ğŸŸ¡ MEDIUM
  FTS triggers               3    ğŸŸ¡ MEDIUM
  Tests                      6    ğŸŸ¡ MEDIUM

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ¯ RECOMMENDATION: Fix Then Merge (2-3 days)

  Day 1: Fix FAISS sync + auto-save (#1, #2)
  Day 2: Fix hybrid search + add tests (#3)
  Day 3: Fix expiration + cleanup code (#4, #5, #6)
  Result: Ready to merge âœ…

  Timeline: 48-72 hours
  Merge risk if unfixed: HIGH (data loss)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“š DOCUMENTATION CREATED

  1. PR_15_REVIEW.md       (Full detailed review with code examples)
  2. PR_15_SUMMARY.md      (Quick reference version)
  3. PR_15_FIXES.md        (Copy-paste ready code fixes)
  4. ARCHITECTURE_ANALYSIS.md (Updated with Phase 1-2 roadmap)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ¨ WHAT'S NEXT (Post-Merge)

  Phase 2: Advanced search (BM25, query DSL, caching)
  Phase 3: Observability (logs, metrics, tracing)
  Phase 4: Scale (PostgreSQL, distributed)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ’¬ KEY QUESTIONS FOR AUTHOR

  Q: Why SQLite instead of PostgreSQL?
  A: Good for local-first MVP. Plan Phase 4 migration.

  Q: How will FAISS sync recovery work in prod?
  A: Need background task to verify DB â†” FAISS on startup.

  Q: Auto-save or explicit save calls?
  A: Recommend debounced auto-save for safety.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

FINAL VERDICT: ğŸŸ¡ REQUEST CHANGES

  âœ… Architecture: Solid (JSONL â†’ SQLite is right move)
  âŒ Implementation: Needs fixes (race conditions, incomplete features)
  â±ï¸  Fix effort: ~18 hours
  ğŸ“… Target: Ready in 2-3 days

Review completed with â¤ï¸ by Amp (Rush Mode)
