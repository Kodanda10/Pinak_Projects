name: CI (Pinak Package)

on:
  push:
    branches: [ main, release/** ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest respx
      - name: Run tests
        run: pytest -q

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Gitleaks (secrets)
        run: |
          curl -sSfL https://raw.githubusercontent.com/gitleaks/gitleaks/master/install.sh | bash -s -- -b /usr/local/bin
          gitleaks version
          gitleaks detect --no-banner --redact --source . --report-path gitleaks.json
      - name: Semgrep (SAST)
        uses: returntocorp/semgrep-action@v1
        continue-on-error: true
        with:
          config: p/ci
      - name: Pip audit + Safety
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: |
          pip install pip-audit safety
          pip-audit -r requirements.txt --progress-spinner=off || true
          safety check -r requirements.txt || true
      - name: IaC (Checkov)
        uses: bridgecrewio/checkov-action@master
        continue-on-error: true
        with:
          directory: Pinak_Services
          quiet: true
          soft_fail: true
      - name: SBOM (Syft)
        uses: anchore/sbom-action@v0
        with:
          path: .

  protect-main:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Block direct pushes to main unless owner override
        run: |
          echo "Direct pushes to main are blocked by policy." >&2
          exit 1
