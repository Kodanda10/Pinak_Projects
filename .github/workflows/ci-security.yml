name: CI Security Gates

on:
  push:
    branches: [ main, feature/** ]
  pull_request:

jobs:
  security:
    runs-on: ubuntu-latest
    env:
      PUBLIC_ASSET: 'true'
      EPSS_THRESHOLD: '0.70'
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - name: Secrets scan (block on fail)
        uses: gitleaks/gitleaks-action@v2
        with:
          redact: true
      - name: Semgrep SAST (block on fail)
        uses: returntocorp/semgrep-action@v1
        with:
          config: .semgrep.yml
          generateSarif: true
      - name: Upload Semgrep SARIF
        if: ${{ always() && hashFiles('semgrep.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
      - name: Dependency audit (informational)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit
          pip-audit -r Pinak_Services/memory_service/requirements.txt --format json > pip_audit.json || true
      - name: Generate SBOM (CycloneDX)
        uses: anchore/sbom-action@v0
        with:
          format: cyclonedx-json
          output-file: sbom-cyclonedx.json
      - name: Gate on KEV-listed vulns
        run: |
          python -m pip install --upgrade pip
          python -c "import sys;print(sys.version)"
          python scripts/ci/check_kev.py pip_audit.json
      - name: EPSS gate (public assets)
        run: |
          python scripts/ci/check_epss.py pip_audit.json
      - name: Comment on PR when security fails
        if: ${{ failure() && github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request.number;
            const url = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const body = `‚ùå CI Security failed. See run: ${url}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr,
              body
            });
