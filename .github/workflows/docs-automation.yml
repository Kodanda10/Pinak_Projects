name: Documentation Automation

on:
  push:
    branches: [ main, feature/**, develop ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'docs/**'
      - 'requirements.txt'
      - 'setup.py'
  pull_request:
    branches: [ main, feature/**, develop ]
    types: [opened, synchronize, reopened, closed]
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force documentation update'
        required: false
        default: false
        type: boolean
      include_coverage:
        description: 'Include coverage reports'
        required: false
        default: true
        type: boolean

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ===== GENERATE DOCUMENTATION =====
  generate-docs:
    name: Generate Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-docs-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-docs-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install -e .
          pip install sphinx sphinx-rtd-theme myst-parser sphinx-autoapi
          pip install coverage pytest pytest-cov

      - name: Generate test coverage (if requested)
        if: github.event.inputs.include_coverage == 'true' || github.event_name != 'workflow_dispatch'
        run: |
          # Run tests with coverage
          python -m pytest tests/ --cov=pinak --cov-report=xml --cov-report=html --cov-report=json
          cp coverage.xml docs/generated/
          cp -r htmlcov docs/generated/

      - name: Generate API documentation
        run: |
          cd docs
          python generate_docs.py --verbose --include-tests --include-coverage

      - name: Generate Sphinx documentation
        run: |
          # Create Sphinx configuration if it doesn't exist
          if [ ! -f "docs/conf.py" ]; then
            cd docs
            sphinx-quickstart --quiet --project="Pinak" --author="Pinak Team" \
              --release="1.0" --language="en" --suffix=".rst" --master="index" \
              --ext-autodoc --ext-doctest --ext-intersphinx --ext-todo \
              --ext-coverage --ext-imgmath --ext-mathjax --ext-ifconfig \
              --ext-viewcode --ext-githubpages --makefile --no-batchfile .
          fi

          # Build Sphinx documentation
          cd docs
          make html

      - name: Update documentation index
        run: |
          # Update docs/index.rst with latest information
          cat > docs/index.rst << 'EOF'
          Welcome to Pinak's documentation!
          ===================================

          .. toctree::
             :maxdepth: 2
             :caption: Contents:

             generated/API_DOCUMENTATION
             generated/architecture
             generated/test_coverage
             generated/ci_status

          Indices and tables
          ==================

          * :ref:`genindex`
          * :ref:`modindex`
          * :ref:`search`
          EOF

      - name: Commit documentation changes
        run: |
          # Check if there are changes to commit
          if git diff --quiet docs/; then
            echo "No documentation changes to commit"
          else
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add docs/
            git commit -m "docs: Auto-update documentation

          - Updated API documentation
          - Updated test coverage reports
          - Updated architecture documentation
          - Updated CI/CD status

          Generated by: ${{ github.workflow }} #${{ github.run_number }}
          Triggered by: ${{ github.event_name }} (${{ github.ref_name }})" || echo "No changes to commit"
          fi

      - name: Push documentation changes
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        run: |
          git push origin main || echo "Push failed - may need manual intervention"

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: generated-documentation
          path: |
            docs/generated/
            docs/build/html/
          retention-days: 30

  # ===== VALIDATE DOCUMENTATION =====
  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest
    needs: generate-docs
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download generated docs
        uses: actions/download-artifact@v4
        with:
          name: generated-documentation
          path: docs/validated/

      - name: Validate documentation structure
        run: |
          # Check for required documentation files
          required_files=(
            "docs/generated/API_DOCUMENTATION.md"
            "docs/generated/api_documentation.html"
            "docs/generated/documentation_summary.json"
          )

          missing_files=()
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
            fi
          done

          if [ ${#missing_files[@]} -gt 0 ]; then
            echo "‚ùå Missing documentation files:"
            printf '%s\n' "${missing_files[@]}"
            exit 1
          else
            echo "‚úÖ All required documentation files present"
          fi

      - name: Validate JSON documentation
        run: |
          # Validate JSON files
          if [ -f "docs/generated/documentation_summary.json" ]; then
            if jq empty docs/generated/documentation_summary.json; then
              echo "‚úÖ Documentation JSON is valid"
            else
              echo "‚ùå Documentation JSON is invalid"
              exit 1
            fi
          fi

      - name: Check documentation completeness
        run: |
          # Check if documentation covers main components
          summary_file="docs/generated/documentation_summary.json"

          if [ -f "$summary_file" ]; then
            # Check for key components in documentation
            components=$(jq -r '.components | keys[]' "$summary_file")

            required_components=(
              "codebase_analysis"
              "api_docs"
              "architecture"
              "test_docs"
              "cicd"
            )

            missing_components=()
            for required in "${required_components[@]}"; do
              if ! echo "$components" | grep -q "^$required$"; then
                missing_components+=("$required")
              fi
            done

            if [ ${#missing_components[@]} -gt 0 ]; then
              echo "‚ö†Ô∏è  Missing documentation components:"
              printf '%s\n' "${missing_components[@]}"
            else
              echo "‚úÖ All required documentation components present"
            fi
          fi

  # ===== DEPLOY DOCUMENTATION =====
  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: [generate-docs, validate-docs]
    if: github.ref == 'refs/heads/main' && needs.validate-docs.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download generated docs
        uses: actions/download-artifact@v4
        with:
          name: generated-documentation
          path: docs/

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs/build/html
          cname: docs.pinak.dev  # Optional: if you have a custom domain

      - name: Update documentation status
        run: |
          # Update docs status in repository
          mkdir -p .docs-status
          cat > .docs-status/last-update.json << EOF
          {
            "last_update": "$(date -Iseconds)",
            "commit": "${{ github.sha }}",
            "workflow_run": "${{ github.run_id }}",
            "status": "success",
            "documentation_url": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          }
          EOF

          # Commit status update
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .docs-status/
          git commit -m "docs: Update documentation status

          Last updated: $(date -Iseconds)
          Commit: ${{ github.sha }}
          Status: ‚úÖ Deployed successfully

          Generated by: ${{ github.workflow }} #${{ github.run_number }}" || echo "Status update committed"

  # ===== NOTIFY ON DOCUMENTATION CHANGES =====
  notify-docs-changes:
    name: Notify Documentation Changes
    runs-on: ubuntu-latest
    needs: [generate-docs, validate-docs, deploy-docs]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check documentation changes
        run: |
          # Check what documentation files changed
          if git diff --name-only HEAD~1 | grep -q "^docs/"; then
            echo "docs_changed=true" >> $GITHUB_ENV
            echo "üìù Documentation files were updated"
          else
            echo "docs_changed=false" >> $GITHUB_ENV
            echo "üìù No documentation changes detected"
          fi

      - name: Generate documentation summary
        run: |
          if [ -f "docs/generated/documentation_summary.json" ]; then
            # Extract key metrics
            total_files=$(jq -r '.components.codebase_analysis.total_files' docs/generated/documentation_summary.json 2>/dev/null || echo "N/A")
            total_lines=$(jq -r '.components.codebase_analysis.total_lines' docs/generated/documentation_summary.json 2>/dev/null || echo "N/A")
            test_files=$(jq -r '.components.test_docs.test_files | length' docs/generated/documentation_summary.json 2>/dev/null || echo "N/A")

            echo "üìä Documentation Summary:" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Files:** $total_files" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Lines:** $total_lines" >> $GITHUB_STEP_SUMMARY
            echo "- **Test Files:** $test_files" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR with documentation status
        if: github.event_name == 'pull_request' && env.docs_changed == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const docsChanged = process.env.DOCS_CHANGED === 'true';
            const prNumber = context.payload.pull_request.number;

            let body = "## üìö Documentation Status\n\n";

            if (docsChanged) {
              body += "‚úÖ **Documentation Updated**\n\n";
              body += "The following documentation has been automatically updated:\n\n";
              body += "- üîç API Documentation\n";
              body += "- üèóÔ∏è Architecture Documentation\n";
              body += "- üß™ Test Documentation\n";
              body += "- üìà Coverage Reports\n\n";
              body += "üìñ [View Documentation](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)\n\n";
            } else {
              body += "‚ÑπÔ∏è **No Documentation Changes**\n\n";
              body += "This PR does not include documentation changes.\n\n";
            }

            // Post comment on PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body
            });

      - name: Slack notification (optional)
        if: env.SLACK_WEBHOOK_URL != '' && needs.deploy-docs.result == 'success'
        run: |
          # Send Slack notification if webhook is configured
          echo "Would send Slack notification if webhook configured"

  # ===== CLEANUP OLD DOCUMENTATION =====
  cleanup-old-docs:
    name: Cleanup Old Documentation
    runs-on: ubuntu-latest
    needs: deploy-docs
    if: github.event_name == 'schedule'  # Only run on scheduled runs
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Clean up old documentation artifacts
        run: |
          # Remove old documentation artifacts (keep last 10)
          if [ -d "docs/generated" ]; then
            # Keep only the most recent 10 documentation generations
            cd docs/generated
            ls -t | tail -n +11 | xargs -r rm -rf
            echo "Cleaned up old documentation artifacts"
          fi

      - name: Clean up old GitHub Pages deployments
        run: |
          # This would clean up old GitHub Pages deployments if needed
          echo "GitHub Pages cleanup would be handled by GitHub automatically"
