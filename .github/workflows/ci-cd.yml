name: CI/CD Pipeline

on: [push, pull_request, workflow_dispatch]

env:
  PINAK_JWT_SECRET: "test-secret-for-ci"

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    - name: Install dependencies
      run: |
        pip install --upgrade uv
        uv sync --frozen
        uv sync --extra tests --project Pinak_Services/memory_service --frozen
    - name: Run memory service tests
      run: |
        cd Pinak_Services/memory_service
        uv run pytest tests/ -v --tb=short --cov=app --cov-report=term-missing --cov-report=xml
      env:
        PINAK_JWT_SECRET: "test-secret-for-ci"
    - name: Run compliance tests
      run: |
        uv run pytest tests/test_compliance_docs.py -v
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      if: always()
      with:
        file: ./Pinak_Services/memory_service/coverage.xml
        flags: unittests
        name: codecov-umbrella
    - name: Lint with flake8
      run: |
        pip install flake8
        flake8 Pinak_Services/memory_service --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 Pinak_Services/memory_service --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  compliance-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Check compliance files exist
      run: |
        echo "Checking for required compliance files..."
        [ -f SECURITY.md ] && echo "✓ SECURITY.md exists" || (echo "✗ SECURITY.md missing" && exit 1)
        [ -f CONTRIBUTING.md ] && echo "✓ CONTRIBUTING.md exists" || (echo "✗ CONTRIBUTING.md missing" && exit 1)
        [ -f LICENSE ] && echo "✓ LICENSE exists" || (echo "✗ LICENSE missing" && exit 1)
        [ -f README.md ] && echo "✓ README.md exists" || (echo "✗ README.md missing" && exit 1)
        echo "All compliance files present!"
    - name: Validate security policy
      run: |
        echo "Validating SECURITY.md content..."
        grep -q "Reporting a Vulnerability" SECURITY.md || (echo "Missing vulnerability reporting section" && exit 1)
        grep -q "security@" SECURITY.md || (echo "Missing security contact" && exit 1)
        echo "✓ SECURITY.md is valid"
    - name: Validate contributing guide
      run: |
        echo "Validating CONTRIBUTING.md content..."
        grep -qi "test" CONTRIBUTING.md || (echo "Missing testing guidelines" && exit 1)
        grep -qi "pull request\|PR" CONTRIBUTING.md || (echo "Missing PR process" && exit 1)
        echo "✓ CONTRIBUTING.md is valid"
    - name: Validate license
      run: |
        echo "Validating LICENSE..."
        grep -q "MIT License" LICENSE || (echo "Not MIT license" && exit 1)
        grep -q "2025" LICENSE || (echo "Missing current year" && exit 1)
        echo "✓ LICENSE is valid"

  build:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    - name: Build Docker image
      run: |
        cd Pinak_Services/memory_service
        docker build -t pinak-memory-service .
    - name: Run container health check
      run: |
        docker run -d --name test-container -e PINAK_JWT_SECRET=test-secret pinak-memory-service
        sleep 15
        # Check if container is running
        docker ps | grep test-container || (echo "Container failed to start" && exit 1)
        # Check health endpoint (if exposed)
        docker logs test-container
        docker stop test-container
        echo "✓ Container health check passed"

  security-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  audit:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    - name: Audit dependencies
      run: |
        pip install pip-audit
        pip-audit --format json || true
      continue-on-error: true

  authorization-tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    - name: Install dependencies
      run: |
        pip install --upgrade uv
        uv sync --extra tests --project Pinak_Services/memory_service --frozen
    - name: Run authorization tests
      run: |
        cd Pinak_Services/memory_service
        uv run pytest tests/test_authorization.py tests/test_authorization_integration.py -v
      env:
        PINAK_JWT_SECRET: "test-secret-for-ci"

  health-check-tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    - name: Install dependencies
      run: |
        pip install --upgrade uv
        uv sync --extra tests --project Pinak_Services/memory_service --frozen
    - name: Run health check tests
      run: |
        cd Pinak_Services/memory_service
        uv run pytest tests/test_health.py -v
      env:
        PINAK_JWT_SECRET: "test-secret-for-ci"

