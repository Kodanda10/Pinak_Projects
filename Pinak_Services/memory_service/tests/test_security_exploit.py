import pytest
import os
import json
from app.services.memory_service import MemoryService
from app.core.database import DatabaseManager

def test_bypass_filter_tenant_hijack(tmp_path):
    """
    Regression test for a security vulnerability where `MemoryService` filter
    could be bypassed by injecting column names into the key, allowing arbitrary
    column updates (like `tenant`) via SQL injection in `DatabaseManager`.
    """
    # Setup
    data_root = tmp_path / "data"
    os.makedirs(data_root, exist_ok=True)
    config_path = tmp_path / "config.json"
    with open(config_path, "w") as f:
        json.dump({"data_root": str(data_root)}, f)

    service = MemoryService(config_path=str(config_path))

    tenant_a = "tenant_a"
    tenant_b = "tenant_b"
    project_id = "p1"

    # 1. Add Memory
    mem = service.add_memory(type('obj', (object,), {'content': 'original', 'tags': []}), tenant_a, project_id)
    mid = mem.id

    # 2. Exploit Payload
    # Attempt to change tenant to tenant_b by bypassing the key filter.
    # Key: "content = 'compromised', tenant"
    # Value: "tenant_b"
    # Expected behavior: The update should FAIL or be sanitized such that tenant is not changed.

    updates = {
        "content = 'compromised', tenant": tenant_b
    }

    try:
        service.update_memory("semantic", mid, updates, tenant_a, project_id)
    except Exception:
        # If it raises an exception (e.g. invalid column), that's good!
        pass

    # 3. Verify
    # Check if memory is NOT in tenant_b
    item_b = service.db.get_memory("semantic", mid, tenant_b, project_id)
    assert item_b is None, "VULNERABILITY: Memory was moved to tenant_b!"

    # Check if memory is still in tenant_a
    item_a = service.db.get_memory("semantic", mid, tenant_a, project_id)
    assert item_a is not None, "Memory disappeared from tenant_a"
    # Ensure content wasn't compromised if the update succeeded partially
    # (Though if we fix it properly, the update should fail completely)
