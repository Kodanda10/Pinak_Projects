
version: '3.8'

services:
  memory-api:
    build: ./memory_service
    read_only: true
    # Internal only; exposed via memory-tls reverse proxy with mTLS
    volumes:
      # Mount the app directory for hot-reloading during development
      - ./memory_service/app:/code/app
      # Mount the data directory to persist the vector index
      - ./memory_service/data:/code/data
      - /tmp
      # Dev TLS certs (generated via scripts/dev_certs.sh)
      - ./certs:/certs:ro
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - PINAK_METRICS=true
    tmpfs:
      - /tmp:rw,size=64m
    depends_on:
      - redis
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--ssl-keyfile", "/certs/memory-api.key", "--ssl-certfile", "/certs/memory-api.crt"]

  redis:
    image: "redis:alpine"
    ports:
      - "6379:6379"

  # Pinak Governance (Gateway)
  pinak-gov-gateway:
    build: ./pinak_gov_gateway
    read_only: true
    environment:
      - GOV_UPSTREAM=http://parlant:8800
      - MEMORY_API_URL=https://memory-tls:8443
      - MEMORY_API_CA=/certs/ca.crt
      - MEMORY_API_CLIENT_CERT=/certs/client-gateway.crt
      - MEMORY_API_CLIENT_KEY=/certs/client-gateway.key
      - OPA_URL=http://opa:8181
      - SECRET_KEY=change-me-in-prod
      - REQUIRE_PROJECT_HEADER=true
    ports:
      - "8880:8880"
    tmpfs:
      - /tmp:rw,size=64m
    networks:
      - prodnet
    volumes:
      - ./certs:/certs:ro
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8880", "--ssl-keyfile", "/certs/gateway.key", "--ssl-certfile", "/certs/gateway.crt"]
    depends_on:
      - memory-api
      - memory-tls
      - opa

  parlant:
    # Prefer in-house GHCR image. Override with PARLANT_IMAGE_REF to pin by tag or digest, e.g.:
    # ghcr.io/pinaka10/parlant:2025-08-27@sha256:abcdef...
    image: ${PARLANT_IMAGE_REF:-ghcr.io/pinaka10/parlant:latest}
    read_only: true
    volumes:
      - parlant-data:/data
    # To build from source instead, uncomment the next two lines and remove the image line.
    # build: ./parlant
    # pull_policy: build
    ports:
      - "8800:8800"
    networks: [prodnet]

  memory-tls:
    image: nginx:alpine
    depends_on:
      - memory-api
    read_only: true
    ports:
      - "8001:8443"
    volumes:
      - ./nginx/memory-tls.conf:/etc/nginx/conf.d/default.conf:ro
      - ./certs:/certs:ro
    networks: [prodnet]

  opa:
    image: openpolicyagent/opa:latest
    command: ["run","--server","/policy"]
    read_only: true
    volumes:
      - ./pinak_gov_gateway/policy:/policy:ro
    networks: [prodnet]

volumes:
  parlant-data:
